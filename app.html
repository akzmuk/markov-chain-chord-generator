<!DOCTYPE html>
<html>
<head>
    <title>Markov Chain Chord Progression Generator</title>
    <style>
        body {
            font-family: Calibri, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
        }
        .controls {
            margin: 1rem 0;
            padding: 1rem;
            background: #e9ecef;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            height: 550px;
        }
        .chord-info {
            margin-top: 1rem;
            padding: 1rem;
            background: #e9ecef;
            border-radius: 8px;
            height: 550px;
        }
        button {
            padding: 0.5rem 1rem;
            font-size: 1rem;
            border: none;
            border-radius: 4px;
            background: #48A69D;
            color: white;
            cursor: pointer;
            margin-right: 0.5rem;
        }
        button:hover {
            background: #32887f;
        }
        #transitions {
            margin-top: 1rem;
        }
        .transition {
            margin: 0.5rem 0;
            padding: 0.5rem;
            background: white;
            border-radius: 4px;
        }
        .volume-control {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 0;
        }

        .volume-control label {
            min-width: 80px;
        }

        .volume-control input[type="range"] {
            flex: 1;
            min-width: 100px;
            max-width: 150px;
        }

        .volume-control span {
            min-width: 60px;
        }
        .circle-of-fifths {
            margin-top: 1rem;
            position: relative;
            width: 300px;
            height: 300px;
        }
        .center-chord {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            font-weight: bold;
            color: #48A69D;
        }
        .chord-node {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .chord-node.active {
            background: #48A69D;
            color: white;
        }
        .chord-node.minor {
            font-size: 0.9em;
            width: 35px;
            height: 35px;
            background: #e0e0e0;
        }
        .chord-node.minor.active {
            background: #48A69D;
            color: white;
        }
        .container {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            gap: 2rem;
            align-items: start;
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        .circle-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: #ddd;
            border-radius: 4px;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #48A69D;
            border-radius: 50%;
            cursor: pointer;
        }
        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #48A69D;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        input[type="range"]::-moz-range-progress {
            background: #48A69D;
            height: 8px;
            border-radius: 4px;
        }
        .header {
            text-align: center;
            color: #48A69D;
            padding: 2rem 0;
            margin-bottom: 1rem;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5rem;
        }
        .chord-selector {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        select {
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid #48A69D;
            font-size: 1rem;
            color: #48A69D;
            background-color: white;
            cursor: pointer;
        }

        select:hover {
            border-color: #32887f;
            color: #32887f;
        }

        select:focus {
            outline: none;
            border-color: #32887f;
            box-shadow: 0 0 0 2px rgba(72, 166, 157, 0.2);
        }

        select option:checked {
            background-color: #48A69D;
            color: white;
        }

        select option:hover {
            background-color: #48A69D;
            color: white;
        }

        input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid #48A69D;
            border-radius: 4px;
            margin-right: 8px;
            position: relative;
            cursor: pointer;
            vertical-align: middle;
        }

        input[type="checkbox"]:checked {
            background-color: #48A69D;
        }

        input[type="checkbox"]:checked::after {
            content: 'âœ“';
            color: white;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
        }

        input[type="checkbox"]:hover {
            border-color: #32887f;
        }

        input[type="checkbox"]:checked:hover {
            background-color: #32887f;
        }
        .project-description {
            margin: 2rem 0;
            padding: 1.5rem;
            background: #e9ecef;
            border-radius: 8px;
            line-height: 1.6;
            text-align: justify;
        }

        .project-description h3 {
            color: #48A69D;
            margin-top: 0;
            margin-bottom: 1rem;
        }

        .project-description p {
            margin: 0.8rem 0;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Markov Chain Chord Progression Generator</h1>
    </div>
    <div class="container">
        <div class="controls">
            <button id="startBtn">Start</button>
            <div class="chord-selector">
                <label for="startingChord">Starting Chord:</label>
                <select id="startingChord">
                </select>
            </div>
            <div class="chord-selector">
                <label for="waveformSelect">Waveform:</label>
                <select id="waveformSelect">
                    <option value="sine">Sine</option>
                    <option value="triangle">Triangle</option>
                    <option value="square">Square</option>
                    <option value="sawtooth">Sawtooth</option>
                </select>
            </div>
            <div class="chord-selector">
                <label>
                    Arpeggio Mode
                    <input type="checkbox" id="arpeggioToggle">
                </label>
            </div>
            <div class="volume-control">
                <label for="volumeSlider">Volume:</label>
                <input type="range" id="volumeSlider" min="0" max="100" value="50">
                <span id="volumeValue">50%</span>
            </div>
            <div class="volume-control">
                <label for="tempoSlider">Tempo:</label>
                <input type="range" id="tempoSlider" min="30" max="120" value="30">
                <span id="tempoValue">30 BPM</span>
            </div>
            <div class="volume-control">
                <label for="lowpassSlider">Lowpass:</label>
                <input type="range" id="lowpassSlider" min="20" max="20000" value="20000" step="1">
                <span id="lowpassValue">20000 Hz</span>
            </div>
            <div class="volume-control">
                <label for="highpassSlider">Highpass:</label>
                <input type="range" id="highpassSlider" min="20" max="20000" value="20" step="1">
                <span id="highpassValue">20 Hz</span>
            </div>
            <div class="volume-control">
                <label for="reverbSlider">Reverb:</label>
                <input type="range" id="reverbSlider" min="0" max="100" value="0">
                <span id="reverbValue">0%</span>
            </div>
            <div class="volume-control">
                <label for="delaySlider">Delay:</label>
                <input type="range" id="delaySlider" min="0" max="100" value="0">
                <span id="delayValue">0%</span>
            </div>
        </div>
        <div>
            <div class="circle-container">
                <div class="circle-of-fifths" id="circleOfFifths">
                    <div class="center-chord" id="centerChord">C</div>
                </div>
            </div>
            <div class="project-description">
                <h3>About This Project</h3>
                <p>
                    This is a generative music tool that creates endless chord progressions using Markov chains. 
                    The circle visualization shows the current chord (highlighted) and its position in the circle of fifths. 
                    Major chords are shown in the outer ring, with their relative minors in the inner ring.
                </p>
                <p>
                    Use the controls on the left to adjust the sound and tempo, and experiment with effects like 
                    reverb, delay, and filters. Toggle arpeggio mode to hear the chords played as sequential notes 
                    rather than simultaneously.
                </p>
            </div>
        </div>
        <div>
            <div class="chord-info">
                <h3>Current Chord: <span id="currentChord">C</span></h3>
                <div id="transitions"></div>
            </div>
        </div>
    </div>

    <script>
        class ChordSynthesizer {
            constructor() {
                this.audioContext = null;
                this.isPlaying = false;
                this.currentChord = 'C';
                this.masterGainNode = null;
                this.tempo = 30;
                this.waveform = 'sine';
                this.lowpassNode = null;
                this.highpassNode = null;
                this.isArpeggio = false;
                this.reverbNode = null;
                this.dryGainNode = null;
                this.wetGainNode = null;
                this.delayNode = null;
                this.delayFeedback = null;
                this.delayWet = null;
                
                this.CHORDS = {
                    'C': 261.63,   // C4
                    'G': 392.00,   // G4
                    'D': 293.66,   // D4
                    'A': 440.00,   // A4
                    'E': 329.63,   // E4
                    'B': 493.88,   // B4
                    'Fâ™¯': 369.99,  // Fâ™¯4
                    'Dâ™­': 277.18,  // Dâ™­4
                    'Aâ™­': 415.30,  // Aâ™­4
                    'Eâ™­': 311.13,  // Eâ™­4
                    'Bâ™­': 466.16,  // Bâ™­4
                    'F': 349.23,   // F4
                    'Am': 440.00,  // A4
                    'Em': 329.63,  // E4
                    'Bm': 493.88,  // B4
                    'Fâ™¯m': 369.99, // Fâ™¯4
                    'Câ™¯m': 277.18, // Câ™¯4
                    'Gâ™¯m': 415.30, // Gâ™¯4
                    'Dâ™¯m': 311.13, // Dâ™¯4
                    'Bâ™­m': 466.16, // Bâ™­4
                    'Fm': 349.23,  // F4
                    'Cm': 261.63,  // C4
                    'Gm': 392.00,  // G4
                    'Dm': 293.66   // D4
                };
                
                this.TRANSITIONS = {
                    'C':  {'G': 0.16, 'F': 0.16, 'Am': 0.16, 'Dm': 0.16, 'Em': 0.16, 'Aâ™­': 0.05, 'Fm': 0.05, 'E': 0.05, 'Câ™¯m': 0.05},
                    'G':  {'C': 0.16, 'D': 0.16, 'Em': 0.16, 'Am': 0.16, 'Bm': 0.16, 'Eâ™­': 0.05, 'Cm': 0.05, 'B': 0.05, 'Gâ™¯m': 0.05},
                    'D':  {'G': 0.16, 'A': 0.16, 'Bm': 0.16, 'Em': 0.16, 'Fâ™¯m': 0.16, 'Bâ™­': 0.05, 'Gm': 0.05, 'Fâ™¯': 0.05, 'Dâ™¯m': 0.05},
                    'A':  {'D': 0.16, 'E': 0.16, 'Fâ™¯m': 0.16, 'Bm': 0.16, 'Câ™¯m': 0.16, 'F': 0.05, 'Dm': 0.05, 'Dâ™­': 0.05, 'Bâ™­m': 0.05},
                    'E':  {'A': 0.16, 'B': 0.16, 'Câ™¯m': 0.16, 'Fâ™¯m': 0.16, 'Gâ™¯m': 0.16, 'C': 0.05, 'Am': 0.05, 'Aâ™­': 0.05, 'Fm': 0.05},
                    'B':  {'E': 0.16, 'Fâ™¯': 0.16, 'Gâ™¯m': 0.16, 'Câ™¯m': 0.16, 'Dâ™¯m': 0.16, 'G': 0.05, 'Em': 0.05, 'Eâ™­': 0.05, 'Cm': 0.05},
                    'Fâ™¯': {'B': 0.16, 'Dâ™­': 0.16, 'Gâ™¯m': 0.16, 'Dâ™¯m': 0.16, 'Bâ™­m': 0.16, 'D': 0.05, 'Bm': 0.05, 'Bâ™­': 0.05, 'Gm': 0.05},
                    'Dâ™­': {'Aâ™­': 0.16, 'Bâ™­m': 0.16, 'Fâ™¯': 0.16, 'Fm': 0.16, 'Dâ™¯m': 0.16, 'A': 0.05, 'Fâ™¯m': 0.05, 'F': 0.05, 'Dm': 0.05},
                    'Aâ™­': {'Dâ™­': 0.16, 'Eâ™­': 0.16, 'Fm': 0.16, 'Bâ™­m': 0.16, 'Cm': 0.16, 'E': 0.05, 'Câ™¯m': 0.05, 'C': 0.05, 'Am': 0.05},
                    'Eâ™­': {'Aâ™­': 0.16, 'Bâ™­': 0.16, 'Cm': 0.16, 'Fm': 0.16, 'Gm': 0.16, 'B': 0.05, 'Gâ™¯m': 0.05, 'G': 0.05, 'Em': 0.05},
                    'Bâ™­': {'Eâ™­': 0.16, 'F': 0.16, 'Gm': 0.16, 'Cm': 0.16, 'Dm': 0.16, 'Fâ™¯': 0.05, 'Dâ™¯m': 0.05, 'D': 0.05, 'Bm': 0.05},
                    'F':  {'Bâ™­': 0.16, 'C': 0.16, 'Dm': 0.16, 'Gm': 0.16, 'Am': 0.16, 'Dâ™­': 0.05, 'Bâ™­m': 0.05, 'A': 0.05, 'Fâ™¯m': 0.05},
                    'Am': {'Dm': 0.16, 'Em': 0.16, 'F': 0.16, 'G': 0.16, 'C': 0.16, 'Aâ™­': 0.05, 'Fm': 0.05, 'E': 0.05, 'Câ™¯m': 0.05},
                    'Em': {'Am': 0.16, 'Bm': 0.16, 'C': 0.16, 'D': 0.16, 'G': 0.16, 'Eâ™­': 0.05, 'Cm': 0.05, 'B': 0.05, 'Gâ™¯m': 0.05},
                    'Bm': {'Em': 0.16, 'Fâ™¯m': 0.16, 'G': 0.16, 'A': 0.16, 'D': 0.16, 'Bâ™­': 0.05, 'Gm': 0.05, 'Fâ™¯': 0.05, 'Dâ™¯m': 0.05},
                    'Fâ™¯m': {'Bm': 0.16, 'Câ™¯m': 0.16, 'D': 0.16, 'E': 0.16, 'A': 0.16, 'F': 0.05, 'Dm': 0.05, 'Dâ™­': 0.05, 'Bâ™­m': 0.05},
                    'Câ™¯m': {'Fâ™¯m': 0.16, 'Gâ™¯m': 0.16, 'A': 0.16, 'B': 0.16, 'E': 0.16, 'C': 0.05, 'Am': 0.05, 'Aâ™­': 0.05, 'Fm': 0.05},
                    'Gâ™¯m': {'Câ™¯m': 0.16, 'Dâ™¯m': 0.16, 'E': 0.16, 'Fâ™¯': 0.16, 'B': 0.16, 'G': 0.05, 'Em': 0.05, 'Eâ™­': 0.05, 'Cm': 0.05},
                    'Dâ™¯m': {'Gâ™¯m': 0.16, 'Bâ™­m': 0.16, 'B': 0.16, 'Dâ™­': 0.16, 'Fâ™¯': 0.16, 'D': 0.05, 'Bm': 0.05, 'Bâ™­': 0.05, 'Gm': 0.05},
                    'Bâ™­m': {'Dâ™¯m': 0.16, 'Fm': 0.16, 'Fâ™¯': 0.16, 'Aâ™­': 0.16, 'Dâ™­': 0.16, 'A': 0.05, 'Fâ™¯': 0.05, 'F': 0.05, 'Dm': 0.05},
                    'Fm': {'Bâ™­m': 0.16, 'Cm': 0.16, 'Aâ™­': 0.16, 'Eâ™­': 0.16, 'Aâ™­': 0.16, 'E': 0.05, 'Câ™¯m': 0.05, 'C': 0.05, 'Am': 0.05},
                    'Cm': {'Fm': 0.16, 'Gm': 0.16, 'Eâ™­': 0.16, 'Bâ™­': 0.16, 'Eâ™­': 0.16, 'B': 0.05, 'Gâ™¯m': 0.05, 'G': 0.05, 'Em': 0.05},
                    'Gm': {'Cm': 0.16, 'Dm': 0.16, 'Bâ™­': 0.16, 'F': 0.16, 'Bâ™­': 0.16, 'Fâ™¯': 0.05, 'Dâ™¯m': 0.05, 'D': 0.05, 'Bm': 0.05},
                    'Dm': {'Gm': 0.16, 'Am': 0.16, 'F': 0.16, 'C': 0.16, 'F': 0.16, 'Dâ™­': 0.05, 'Bâ™­m': 0.05, 'A': 0.05, 'Fâ™¯m': 0.05}
                };

                this.CIRCLE_CHORDS = ['C', 'G', 'D', 'A', 'E', 'B', 'Fâ™¯', 'Dâ™­', 'Aâ™­', 'Eâ™­', 'Bâ™­', 'F'];
                this.CIRCLE_MINORS = ['Am', 'Em', 'Bm', 'Fâ™¯m', 'Câ™¯m', 'Gâ™¯m', 'Dâ™¯m', 'Bâ™­m', 'Fm', 'Cm', 'Gm', 'Dm'];
                
                this.startBtn = document.getElementById('startBtn');
                this.bindEvents();
                this.updateUI();
                this.setupCircleOfFifths();
                this.populateChordSelector();
            }

            bindEvents() {
                this.startBtn.addEventListener('click', () => {
                    if (this.isPlaying) {
                        this.stop();
                        this.startBtn.textContent = 'Start';
                    } else {
                        this.start();
                        this.startBtn.textContent = 'Stop';
                    }
                });
                
                const volumeSlider = document.getElementById('volumeSlider');
                volumeSlider.addEventListener('input', (e) => {
                    const volume = e.target.value / 100;
                    document.getElementById('volumeValue').textContent = `${e.target.value}%`;
                    if (this.masterGainNode) {
                        this.masterGainNode.gain.setValueAtTime(volume, this.audioContext?.currentTime || 0);
                    }
                });

                document.getElementById('volumeValue').textContent = `${volumeSlider.value}%`;

                const tempoSlider = document.getElementById('tempoSlider');
                tempoSlider.value = "30";
                document.getElementById('tempoValue').textContent = "30 BPM";
                
                tempoSlider.addEventListener('input', (e) => {
                    this.tempo = parseInt(e.target.value);
                    document.getElementById('tempoValue').textContent = `${this.tempo} BPM`;
                });

                const waveformSelect = document.getElementById('waveformSelect');
                waveformSelect.addEventListener('change', (e) => {
                    this.waveform = e.target.value;
                });

                const lowpassSlider = document.getElementById('lowpassSlider');
                const highpassSlider = document.getElementById('highpassSlider');

                const updateFilter = (slider, valueId, filterNode, type) => {
                    const minValue = Math.log(20);
                    const maxValue = Math.log(20000);
                    const scale = (maxValue - minValue) / (slider.max - slider.min);
                    const value = Math.exp(minValue + scale * (slider.value - slider.min));
                    const roundedValue = Math.round(value);
                    
                    document.getElementById(valueId).textContent = `${roundedValue} Hz`;
                    if (filterNode) {
                        filterNode.frequency.setValueAtTime(roundedValue, this.audioContext?.currentTime || 0);
                    }
                };

                lowpassSlider.addEventListener('input', () => {
                    updateFilter(lowpassSlider, 'lowpassValue', this.lowpassNode);
                });

                highpassSlider.addEventListener('input', () => {
                    updateFilter(highpassSlider, 'highpassValue', this.highpassNode);
                });

                const arpeggioToggle = document.getElementById('arpeggioToggle');
                arpeggioToggle.addEventListener('change', (e) => {
                    this.isArpeggio = e.target.checked;
                });

                const reverbSlider = document.getElementById('reverbSlider');
                reverbSlider.addEventListener('input', (e) => {
                    const reverbMix = e.target.value / 100;
                    document.getElementById('reverbValue').textContent = `${e.target.value}%`;
                    
                    if (this.dryGainNode && this.wetGainNode) {
                        this.dryGainNode.gain.setValueAtTime(1 - reverbMix, this.audioContext?.currentTime || 0);
                        this.wetGainNode.gain.setValueAtTime(reverbMix, this.audioContext?.currentTime || 0);
                    }
                });

                const delaySlider = document.getElementById('delaySlider');
                delaySlider.addEventListener('input', (e) => {
                    const delayMix = e.target.value / 100;
                    document.getElementById('delayValue').textContent = `${e.target.value}%`;
                    
                    if (this.delayWet) {
                        this.delayWet.gain.setValueAtTime(delayMix, this.audioContext?.currentTime || 0);
                    }
                });
            }

            setupCircleOfFifths() {
                const container = document.getElementById('circleOfFifths');
                const outerRadius = 120;
                const innerRadius = 70;
                const center = { x: 150, y: 150 };

                this.CIRCLE_CHORDS.forEach((chord, index) => {
                    const angle = (index * 30 - 90) * (Math.PI / 180);
                    const x = center.x + outerRadius * Math.cos(angle);
                    const y = center.y + outerRadius * Math.sin(angle);

                    const node = document.createElement('div');
                    node.className = 'chord-node';
                    node.textContent = chord;
                    node.style.left = `${x - 20}px`;
                    node.style.top = `${y - 20}px`;
                    
                    container.appendChild(node);
                });

                this.CIRCLE_MINORS.forEach((chord, index) => {
                    const angle = (index * 30 - 90) * (Math.PI / 180);
                    const x = center.x + innerRadius * Math.cos(angle);
                    const y = center.y + innerRadius * Math.sin(angle);

                    const node = document.createElement('div');
                    node.className = 'chord-node minor';
                    node.textContent = chord;
                    node.style.left = `${x - 17.5}px`;
                    node.style.top = `${y - 17.5}px`;
                    
                    container.appendChild(node);
                });
            }

            updateCircleOfFifths() {
                const nodes = document.querySelectorAll('.chord-node');
                nodes.forEach(node => {
                    node.classList.remove('active');
                    if (node.textContent.trim() === this.currentChord.trim()) {
                        node.classList.add('active');
                    }
                });
            }

            populateChordSelector() {
                const selector = document.getElementById('startingChord');
                const allChords = [...this.CIRCLE_CHORDS, ...this.CIRCLE_MINORS];
                
                allChords.forEach(chord => {
                    const option = document.createElement('option');
                    option.value = chord;
                    option.textContent = chord;
                    if (chord === this.currentChord) {
                        option.selected = true;
                    }
                    selector.appendChild(option);
                });

                selector.addEventListener('change', (e) => {
                    this.currentChord = e.target.value;
                    this.updateUI();
                });
            }

            async createReverb() {
                const convolver = this.audioContext.createConvolver();
                
                const sampleRate = this.audioContext.sampleRate;
                const length = sampleRate * 2.5;
                const impulse = this.audioContext.createBuffer(2, length, sampleRate);
                
                for (let channel = 0; channel < 2; channel++) {
                    const channelData = impulse.getChannelData(channel);
                    for (let i = 0; i < length; i++) {
                        const decay = Math.exp(-i / (sampleRate * 0.5));
                        channelData[i] = (Math.random() * 2 - 1) * decay;
                    }
                }
                
                convolver.buffer = impulse;
                return convolver;
            }

            createDelay() {
                const delay = this.audioContext.createDelay(2.0);
                delay.delayTime.value = 0.3;
                const feedback = this.audioContext.createGain();
                feedback.gain.value = 0.4;

                const wet = this.audioContext.createGain();
                wet.gain.value = 0;

                delay.connect(feedback);
                feedback.connect(delay);
                delay.connect(wet);

                return { delay, feedback, wet };
            }

            async start() {
                if (this.isPlaying) return;
                
                this.currentChord = document.getElementById('startingChord').value;
                this.updateUI();
                
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                this.masterGainNode = this.audioContext.createGain();
                const volume = document.getElementById('volumeSlider').value / 100;
                this.masterGainNode.gain.setValueAtTime(volume, this.audioContext.currentTime);
                
                const delayNetwork = this.createDelay();
                this.delayNode = delayNetwork.delay;
                this.delayFeedback = delayNetwork.feedback;
                this.delayWet = delayNetwork.wet;
                
                this.reverbNode = await this.createReverb();
                this.dryGainNode = this.audioContext.createGain();
                this.wetGainNode = this.audioContext.createGain();
                
                const reverbValue = document.getElementById('reverbSlider').value / 100;
                const delayValue = document.getElementById('delaySlider').value / 100;
                
                this.dryGainNode.gain.value = 1 - reverbValue;
                this.wetGainNode.gain.value = reverbValue;
                this.delayWet.gain.value = delayValue;
                
                this.dryGainNode.connect(this.audioContext.destination);
                this.wetGainNode.connect(this.reverbNode);
                this.reverbNode.connect(this.audioContext.destination);
                this.delayWet.connect(this.audioContext.destination);
                
                const lowpassValue = document.getElementById('lowpassSlider').value;
                const highpassValue = document.getElementById('highpassSlider').value;
                
                if (!this.lowpassNode) {
                    this.lowpassNode = this.audioContext.createBiquadFilter();
                    this.lowpassNode.type = 'lowpass';
                    this.lowpassNode.frequency.setValueAtTime(lowpassValue, this.audioContext.currentTime);
                }
                
                if (!this.highpassNode) {
                    this.highpassNode = this.audioContext.createBiquadFilter();
                    this.highpassNode.type = 'highpass';
                    this.highpassNode.frequency.setValueAtTime(highpassValue, this.audioContext.currentTime);
                }
                
                this.tempo = parseInt(document.getElementById('tempoSlider').value);
                
                this.waveform = document.getElementById('waveformSelect').value;
                
                this.isArpeggio = document.getElementById('arpeggioToggle').checked;
                
                this.isPlaying = true;
                
                const baseFreq = this.CHORDS[this.currentChord];
                const type = this.currentChord.endsWith('m') ? 'minor' : 'major';
                const duration = this.playChord(baseFreq, type);
                
                setTimeout(() => {
                    this.currentChord = this.getNextChord();
                    this.updateUI();
                    this.playNextChord();
                }, duration * 1000);
            }

            stop() {
                if (!this.isPlaying) return;
                
                const startingChordSelect = document.getElementById('startingChord');
                startingChordSelect.value = this.currentChord;
                
                this.isPlaying = false;
                if (this.audioContext) {
                    this.audioContext.close();
                    this.audioContext = null;
                    this.lowpassNode = null;
                    this.highpassNode = null;
                    this.reverbNode = null;
                    this.dryGainNode = null;
                    this.wetGainNode = null;
                    this.delayNode = null;
                    this.delayFeedback = null;
                    this.delayWet = null;
                }
            }

            createOscillator(frequency, startTime, duration) {
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                if (!this.lowpassNode) {
                    this.lowpassNode = this.audioContext.createBiquadFilter();
                    this.lowpassNode.type = 'lowpass';
                    this.lowpassNode.frequency.setValueAtTime(20000, this.audioContext.currentTime);
                    this.lowpassNode.Q.setValueAtTime(1, this.audioContext.currentTime);
                }
                
                if (!this.highpassNode) {
                    this.highpassNode = this.audioContext.createBiquadFilter();
                    this.highpassNode.type = 'highpass';
                    this.highpassNode.frequency.setValueAtTime(20, this.audioContext.currentTime);
                    this.highpassNode.Q.setValueAtTime(1, this.audioContext.currentTime);
                }

                oscillator.type = this.waveform;
                oscillator.frequency.value = frequency;
                
                gainNode.gain.setValueAtTime(0, startTime);
                gainNode.gain.linearRampToValueAtTime(0.2, startTime + 0.1);
                gainNode.gain.linearRampToValueAtTime(0, startTime + duration);
                
                oscillator.connect(gainNode);
                gainNode.connect(this.highpassNode);
                this.highpassNode.connect(this.lowpassNode);
                
                this.lowpassNode.connect(this.masterGainNode);
                this.masterGainNode.connect(this.dryGainNode);
                this.masterGainNode.connect(this.wetGainNode);
                this.masterGainNode.connect(this.delayNode);
                
                return oscillator;
            }

            playChord(baseFreq, type = 'major') {
                const now = this.audioContext.currentTime;
                const duration = 60 / this.tempo;
                
                const multipliers = type === 'major' 
                    ? [1, 1.25, 1.5, 1.25]
                    : [1, 1.2, 1.5, 1.2];
                
                if (this.isArpeggio) {
                    const noteDelay = duration / multipliers.length;
                    multipliers.forEach((mult, index) => {
                        const osc = this.createOscillator(baseFreq * mult, now + (index * noteDelay), noteDelay);
                        osc.start(now + (index * noteDelay));
                        osc.stop(now + (index * noteDelay) + noteDelay);
                    });
                } else {
                    multipliers.forEach(mult => {
                        const osc = this.createOscillator(baseFreq * mult, now, duration);
                        osc.start(now);
                        osc.stop(now + duration);
                    });
                }
                
                return duration;
            }

            getNextChord() {
                const transitions = this.TRANSITIONS[this.currentChord];
                const chords = Object.keys(transitions);
                const probabilities = Object.values(transitions);
                
                const random = Math.random();
                let sum = 0;
                
                for (let i = 0; i < chords.length; i++) {
                    sum += probabilities[i];
                    if (random < sum) return chords[i];
                }
                
                return chords[0];
            }

            updateUI() {
                document.getElementById('currentChord').textContent = this.currentChord;
                document.getElementById('centerChord').textContent = this.currentChord;
                
                const transitionsDiv = document.getElementById('transitions');
                transitionsDiv.innerHTML = '<h4>Possible Transitions:</h4>';
                
                Object.entries(this.TRANSITIONS[this.currentChord]).forEach(([chord, prob]) => {
                    const div = document.createElement('div');
                    div.className = 'transition';
                    div.textContent = `${this.currentChord} â†’ ${chord}: ${(prob * 100).toFixed(1)}%`;
                    transitionsDiv.appendChild(div);
                });

                this.updateCircleOfFifths();
            }

            playNextChord() {
                if (!this.isPlaying) return;
                
                const baseFreq = this.CHORDS[this.currentChord];
                const type = this.currentChord.endsWith('m') ? 'minor' : 'major';
                const duration = this.playChord(baseFreq, type);
                
                this.currentChord = this.getNextChord();
                this.updateUI();
                
                setTimeout(() => this.playNextChord(), duration * 1000);
            }
        }

        const synth = new ChordSynthesizer();
    </script>
</body>
</html>